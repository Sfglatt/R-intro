---
title: "03_correlation_regression"
author: "Sglatt"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages
```{r packages}
if (!require("apaTables")) {install.packages("apaTables"); require("apaTables")} 
# This packages creates APA-style publication-ready tables for basic analyses (e.g., correlations, regression, ANOVA)
# https://dstanley4.github.io/apaTables/articles/apaTables.html

if (!require("corrplot")) {install.packages("corrplot"); require("corrplot")} 
if (!require("ggcorrplot")) {install.packages("ggcorrplot"); require("ggcorrplot")} 
if (!require("GGally")) {install.packages("GGally"); require("GGally")} 
# Visualize a correlation matrix
# For corrplot: https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html
# For ggcorrplot: https://rpubs.com/Alema/1000474
# For GGally: https://ggobi.github.io/ggally/articles/ggpairs.html

if (!require("dplyr")) {install.packages("dplyr"); require("dplyr")} 
# Select data

if (!require("rempsyc")) {install.packages("rempsyc"); require("rempsyc")} 
# Linear regression model assumption tests
# https://cran.r-project.org/web/packages/rempsyc/vignettes/assumptions.html

if (!require("performance")) {install.packages("performance"); require("performance")} 
if (!require("see")) {install.packages("see"); require("see")} 
# These packages are great to visualize linear regression model assumptions. 

if (!require("psych")) {install.packages("psych"); require("psych")} 
# For data

if (!require("report")) {install.packages("report"); require("report")} 
# To interpret basic analysis objects!
# # https://www.rdocumentation.org/packages/report/versions/0.6.0
```

# Data and directory
```{r data}
# R and some packages come with some built in datasets! To see them, run the function data()
data()

# For this script, we'll use the 'bfi' dataset from the 'psych' package, which has 25 personality items. 
# For information about this dataset: https://www.personality-project.org/r/html/bfi.html

# To load it, use the data() function
data(bfi)

# Look at the dataset: 
View(bfi)

# The dataset has items, but we want total scores. If you look at the dataset documentation, it provides code to score the items. 
keys.list <- list(agree = c("-A1","A2","A3","A4","A5"),
                  conscientious = c("C1","C2","C3","-C4","-C5"),
                  extraversion = c("-E1","-E2","E3","E4","E5"),
                  neuroticism = c("N1","N2","N3","N4","N5"), 
                  openness = c("O1","-O2","O3","O4","-O5")) 
scores <- scoreItems(keys.list, bfi, min = 1, max = 6)  # or just use the keys.list
View(scores) # When you view the 'scores' object, you will see that it is a list. We want to access the 'scores' element from the list.
View(scores$scores)

# Make the 'scores' dataframe into an object
data_scores <- scores$scores

# How do we combine the scores dataframe with the 'bfi' dataframe? 
# Since the two datasets have the same number of rows and are aligned row-wise, you can use the 'cbind()' function to bind the columns together. This just adds columns from the 'scores' dataset into the 'bfi' dataset: 
bfi <- cbind(bfi, data_scores)

View(bfi)

# Create a folder to save the output
dir.create("03_Output")
```

# Correlation matrix
```{r matrix}
# Use apaTables!

# Let's make the correlationmatrix + save this table in APA format.
# For documentation / how to use the function: https://www.rdocumentation.org/packages/apaTables/versions/2.0.8/topics/apa.cor.table

# First, we should filter the dataset to just include the total scores. 
colnames(bfi)
bfi_filtered <- bfi %>% 
  dplyr::select(conscientious, extraversion, neuroticism, openness)

Matrix <- apa.cor.table(bfi_filtered, 
                        filename = "03_Output/Correlation_matrix.doc",
                        table.number = 1, 
                        show.conf.interval = TRUE, 
                        show.sig.stars = TRUE, 
                        landscape = TRUE)

# Look at it
Matrix

# Visualize the matrix with the corrplot package
# https://cran.r-project.org/web/packages/corrplot/vignettes/corrplot-intro.html

# corrplot needs a basic correlation matrix as input. 
# The cor() function can provide the input.
corr_mat <- cor(bfi_filtered,
                method = 'pearson', # The default method is pearson, so if you don't include this line you will get identical results.
                use = 'pairwise.complete.obs') # Use complete observations = missing data will be deleted.

# Print the correlation matrix
corr_mat

# You can also calculate a single correlation between two variables
cor(bfi_filtered$extraversion, bfi_filtered$neuroticism, use = 'pairwise.complete.obs')

# To get the p-value, use cor.test()
?cor.test
cor.test(bfi_filtered$extraversion, bfi_filtered$neuroticism, use = 'pairwise.complete.obs')

# Visualize the matrix with 'corrplot':
corrplot(corr_mat) # The default corrplot function provides the correlation strength through shape size
corrplot(corr_mat, method = 'number') # you can get numbers in the matrix by setting method = 'number'
corrplot.mixed(corr_mat) # ...and corrplot.mixed() will give you both the shapes and and numbers 
corrplot(corr_mat, type = "lower", tl.col = "black", tl.srt = 45) # Change some more features. There are much more details you can change (all in the html above)!

# Alternatively, visualize the matrix with 'ggcorrplot'
# The corr_mat object above can be the input:
ggcorrplot(corr_mat) # The default method for the shape is a square
ggcorrplot(corr_mat, method = "circle")
ggcorrplot(corr_mat, # Change other settings
 method = "square", 
 type = "lower",
 outline.color = "white",
# lab = TRUE, # If you want numbers as well as colors
 lab_size = 2)

# For correlations as scatterplots, distributions, and printed corrleation coefficients
ggpairs(bfi_filtered, columns = 1:4, title = "Correlogram with ggpairs()") 
# For more settings: https://ggobi.github.io/ggally/articles/ggpairs.html

# To save the visualization(s), 
# The pdf() function lets you direct your plot output to a PDF file
# The png() function lets you direct your plot output to a PNG file
# Begin with one of these functions, and then plot the figure (or run an object of the figure).
# dev.off() is used to close the graphics device. This step finalizes and saves the plot to the file (PDF or PNG).

# Here,
pdf("03_Output/Corr_matrix_figure.pdf", width = 10, height = 10) 
# Use pdf() to specify where the figure should be saved, the name of the file. and the height/width 
# (It can take trial and error to find the size you like!)

corrplot(corr_mat, type = "lower", tl.col = "black", tl.srt = 45) 
 # Visualize/plot the matrix with corrplot

dev.off() 
# Finalize the PDF. Now the PDF figure will be in your output folder!

# Similarly, for a PNG, 
png("03_Output/Corr_matrix_figure.png", width = 1000, height = 1000) 
# Use png() to specify where the figure should be saved (name of the file and the size of the image)
# 'width' and 'height' are in pixels. 

corrplot(corr_mat, type = "lower", tl.col = "black", tl.srt = 45)

dev.off() 
```

# Linear regression
```{r lm}
# The base linear regression function, lm(), is included in base R. 
# The form is lm(outcome_variable ~ predictor_variable_1 + predictor_variable_2, data = your_dataset). 
?lm

# For example, lets look at neuroticism and openness as predictors, and extraversion as the outcome:
regr_model_two_vars <- lm(extraversion ~ neuroticism + openness, data = bfi_filtered) # fit regression model

# Obtain a summary of your model
summary(regr_model_two_vars)

# Check the linear model assumptions. The 'check_model' function from the performance package has an excellent visualization for this:  
check_model(regr_model_two_vars)

# Statistical tests (normality, homoscedasticity, autocorrelation) with 'nice_assumptions' from the 'rempsych' package:
nice_assumptions(regr_model_two_vars)
# p < .05 means that assumptions are violated
# The 'Diagnostic' value is how many assumptions are violated. Here, one assumption was violated.

# Let's make an APA table:
# For documentation / how to use the function: https://www.rdocumentation.org/packages/apaTables/versions/2.0.8/topics/apa.reg.table
Regression_table <- apa.reg.table(regr_model_two_vars, 
                                  filename = "03_Output/Regression_table.doc", 
                                  table.number = 2)

# Look at it
Regression_table

# If you want a stepwise regression table (as in, model one has the first predictor variable, and model two has both predictor variables): # You already have the model with both predictor variables - the 'regr_model_two_vars' object. 
# Now, create a lm with just the first predictor:
regr_model_one_var <- lm(extraversion ~ neuroticism, data = bfi_filtered)
# Now, regr_model_one_var has neuroticm --> extraversion, 
# And regr_model_two_vars has neuroticism + openness --> extraversion. 

# Obtain a summary of your model
summary(regr_model_one_var)

# Check the linear model assumptions
check_model(regr_model_one_var)

# Now, to make a stepwise regression APA Table, you use the same argument as before - however, include the first model ('block 1') followed by the second model ('block 2').
# These instructions are included in https://www.rdocumentation.org/packages/apaTables/versions/2.0.8/topics/apa.reg.table!

Regression_stepwise_table <- apa.reg.table(regr_model_one_var,  # one predictor variable
                                           regr_model_two_vars, # both predictor variables
                                           filename = "03_Output/Stepwise_regression_table.doc", 
                                           table.number = 3)

# How to write up these results? 
# The report() function is so handy for this! 
# https://www.rdocumentation.org/packages/report/versions/0.6.0

# Generate a verbal summary of the models:
report(regr_model_one_var)
report(regr_model_two_vars)

# You can even use this to report participant demographics! This is done with the 'report_participants' function. 
# Let's select two demographic variables.  
# We can isolate the variable that we want within the argument with base R. 
# Remember, this follows the format [rows, columns].

report_participants(bfi[, c("age", "education")], spell_n = TRUE)
# In the output, you can see that mean education was treated as a numeric variable.
# We want it to be a factor, because each number represents a level. 
# Let's modify that with 'as.factor()'

bfi$education <- as.factor(bfi$education)
report_participants(bfi[, c("age", "education")], spell_n = TRUE)
```

# ANOVA
```{r anova}
# Question: Is there a difference in extraversion scores between education levels?
# the aov() function from base R does an ANOVA. This follows the same format as the lm()!

anova_education <- aov(extraversion ~ education, data = bfi) # fit anova

# Obtain a summary of your model
summary(anova_education)

# After ANOVA, you will often report pairwise comparisons. The TukeyHSD() function will do this:
TukeyHSD(anova_education) 

# ANOVA and linear models are actually same analysis! Let's fit an lm() and compare the output to the aov()
lm_education <- lm(extraversion ~ education, data = bfi) 
summary(lm_education)
# They have the same F statistics and p value!

# Using APA tables, you can make an ANOVA table! This is done by using the lm as input - not the aov:
anova_table <- apa.aov.table(
  lm_education,
  filename = "03_Output/ANOVA_table.doc",
  table.number = 4,
  conf.level = 0.95,
  type = 3
)

# Let's report this! 
report(anova_education)
```

